--- bazel/build_defs.bzl
+++ bazel/build_defs.bzl
@@ -37,6 +37,7 @@
     "-Werror",
     "-Wno-unused-parameter",
     "-Wno-long-long",
+    "-std=c++14",
 ])
 _DEFAULT_COPTS.extend([
     "-std=c99",

--- bazel/upb_proto_library.bzl
+++ bazel/upb_proto_library.bzl
@@ -74,13 +74,13 @@
     real_short_path = _get_real_short_path(file)
     root = file.path[:-len(real_short_path) - 1]
 
-    if not _is_google3 and ctx.rule.attr.strip_import_prefix:
+    if False:
         root = paths.join(root, ctx.rule.attr.strip_import_prefix[1:])
     return root
 
 def _generate_output_file(ctx, src, extension):
     package = ctx.label.package
-    if not _is_google3:
+    if False:
         strip_import_prefix = ctx.rule.attr.strip_import_prefix
         if strip_import_prefix and strip_import_prefix != "/":
             if not package.startswith(strip_import_prefix[1:]):

--- upb/reflection/common.h
+++ upb/reflection/common.h
@@ -25,7 +25,7 @@
  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  */
 
-// IWYU pragma: private, include "third_party/upb/upb/reflection/def.h"
+// IWYU pragma: private, include "upb/reflection/def.h"
 
 // Declarations common to all public def types.
 

--- upb/reflection/def_pool.h
+++ upb/reflection/def_pool.h
@@ -25,7 +25,7 @@
  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  */
 
-// IWYU pragma: private, include "third_party/upb/upb/reflection/def.h"
+// IWYU pragma: private, include "upb/reflection/def.h"
 
 #ifndef UPB_REFLECTION_DEF_POOL_H_
 #define UPB_REFLECTION_DEF_POOL_H_

--- upb/reflection/enum_def.h
+++ upb/reflection/enum_def.h
@@ -25,7 +25,7 @@
  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  */
 
-// IWYU pragma: private, include "third_party/upb/upb/reflection/def.h"
+// IWYU pragma: private, include "upb/reflection/def.h"
 
 #ifndef UPB_REFLECTION_ENUM_DEF_H_
 #define UPB_REFLECTION_ENUM_DEF_H_

--- upb/reflection/enum_value_def.h
+++ upb/reflection/enum_value_def.h
@@ -25,7 +25,7 @@
  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  */
 
-// IWYU pragma: private, include "third_party/upb/upb/reflection/def.h"
+// IWYU pragma: private, include "upb/reflection/def.h"
 
 #ifndef UPB_REFLECTION_ENUM_VALUE_DEF_H_
 #define UPB_REFLECTION_ENUM_VALUE_DEF_H_

--- upb/reflection/extension_range.h
+++ upb/reflection/extension_range.h
@@ -25,7 +25,7 @@
  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  */
 
-// IWYU pragma: private, include "third_party/upb/upb/reflection/def.h"
+// IWYU pragma: private, include "upb/reflection/def.h"
 
 #ifndef UPB_REFLECTION_EXTENSION_RANGE_H_
 #define UPB_REFLECTION_EXTENSION_RANGE_H_

--- upb/reflection/field_def.h
+++ upb/reflection/field_def.h
@@ -25,7 +25,7 @@
  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  */
 
-// IWYU pragma: private, include "third_party/upb/upb/reflection/def.h"
+// IWYU pragma: private, include "upb/reflection/def.h"
 
 #ifndef UPB_REFLECTION_FIELD_DEF_H_
 #define UPB_REFLECTION_FIELD_DEF_H_

--- upb/reflection/file_def.h
+++ upb/reflection/file_def.h
@@ -25,7 +25,7 @@
  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  */
 
-// IWYU pragma: private, include "third_party/upb/upb/reflection/def.h"
+// IWYU pragma: private, include "upb/reflection/def.h"
 
 #ifndef UPB_REFLECTION_FILE_DEF_H_
 #define UPB_REFLECTION_FILE_DEF_H_

--- upb/reflection/message_def.h
+++ upb/reflection/message_def.h
@@ -25,7 +25,7 @@
  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  */
 
-// IWYU pragma: private, include "third_party/upb/upb/reflection/def.h"
+// IWYU pragma: private, include "upb/reflection/def.h"
 
 #ifndef UPB_REFLECTION_MESSAGE_DEF_H_
 #define UPB_REFLECTION_MESSAGE_DEF_H_

--- upb/reflection/method_def.h
+++ upb/reflection/method_def.h
@@ -25,7 +25,7 @@
  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  */
 
-// IWYU pragma: private, include "third_party/upb/upb/reflection/def.h"
+// IWYU pragma: private, include "upb/reflection/def.h"
 
 #ifndef UPB_REFLECTION_METHOD_DEF_H_
 #define UPB_REFLECTION_METHOD_DEF_H_

--- upb/reflection/oneof_def.h
+++ upb/reflection/oneof_def.h
@@ -25,7 +25,7 @@
  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  */
 
-// IWYU pragma: private, include "third_party/upb/upb/reflection/def.h"
+// IWYU pragma: private, include "upb/reflection/def.h"
 
 #ifndef UPB_REFLECTION_ONEOF_DEF_H_
 #define UPB_REFLECTION_ONEOF_DEF_H_

--- upb/reflection/service_def.h
+++ upb/reflection/service_def.h
@@ -25,7 +25,7 @@
  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  */
 
-// IWYU pragma: private, include "third_party/upb/upb/reflection/def.h"
+// IWYU pragma: private, include "upb/reflection/def.h"
 
 #ifndef UPB_REFLECTION_SERVICE_DEF_H_
 #define UPB_REFLECTION_SERVICE_DEF_H_

--- upbc/BUILD
+++ upbc/BUILD
@@ -98,7 +98,7 @@
         "//:upb",
         "@com_google_absl//absl/container:flat_hash_map",
         "@com_google_absl//absl/strings",
-        "@com_google_protobuf//src/google/protobuf/compiler:code_generator",
+        "@com_google_protobuf//:protoc_lib",
     ],
 )
 
@@ -128,7 +128,7 @@
         "@com_google_absl//absl/container:flat_hash_map",
         "@com_google_absl//absl/strings",
         "@com_google_protobuf//:protobuf",
-        "@com_google_protobuf//src/google/protobuf/compiler:code_generator",
+        "@com_google_protobuf//:protoc_lib",
     ],
 )
 
@@ -149,7 +149,7 @@
         "@com_google_absl//absl/container:flat_hash_set",
         "@com_google_absl//absl/strings",
         "@com_google_protobuf//:protobuf",
-        "@com_google_protobuf//src/google/protobuf/compiler:code_generator",
+        "@com_google_protobuf//:protoc_lib",
     ],
 )
 
@@ -166,7 +166,7 @@
         "@com_google_absl//absl/container:flat_hash_map",
         "@com_google_absl//absl/strings",
         "@com_google_protobuf//:protobuf",
-        "@com_google_protobuf//src/google/protobuf/compiler:code_generator",
+        "@com_google_protobuf//:protoc_lib",
     ],
 )
 
